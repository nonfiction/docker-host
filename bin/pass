#!/bin/bash

# https://doc.traefik.io/traefik/middlewares/basicauth/

# pass BASICAUTH_USER BASICAUTH_PASSWORD

# > attempts to load BASICAUTH_USER from .env and environment
# > falls back on named file in CWD or /usr/local/env

# > attempts to load BASICAUTH_PASSWORD from .env and environment
# > falls back on named file in CWD or /usr/local/env

# > returns name:password hashed with $ doubled for escaping: 


# Exit if arguments missing
[ -z "$2" ] && exit 1

# Load dotenv if available
[ -e .env ] && dotenv="$(egrep -v '^#' .env | xargs)"
[ -z "$dotenv" ] || export "$dotenv"

# Set value from environment
name="${!1}"

# If this is null, load from file
if [ -z "$name" ]; then

  # Try to load filename as-is
  if [ -e "${1}" ]; then
    name="$(cat ${1})"

  # If that doesn't exist, try to load it under /usr/local/env/
  elif [ -e "/usr/local/env/${1}" ]; then
    name="$(cat /usr/local/env/${1})"

  else
    exit 1
  fi

fi

# Set value from environment
password="${!2}"

# If this is null, load from file
if [ -z "$password" ]; then

  # Try to load filename as-is
  if [ -e "${2}" ]; then
    password="$(cat ${2})"

  # If that doesn't exist, try to load it under /usr/local/env/
  elif [ -e "/usr/local/env/${2}" ]; then
    password="$(cat /usr/local/env/${2})"

  else
    exit 1
  fi

fi

# Hash password
echo $(htpasswd -nb $name $password) | sed -e s/\\$/\\$\\$/g

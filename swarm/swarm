#!/bin/bash

# # Load up .env
# [ -e .env ] && export $(cat .env)

# Bash helper functions
if [ -e /root/platform/swarm/lib/helpers.sh ]; then source /root/platform/swarm/lib/helpers.sh;
else source <(curl -fsSL https://github.com/nonfiction/platform/raw/master/swarm/lib/helpers.sh); fi

# First parameter is name of swarm and primary node
SWARM=$(node_from_fqdn $1);
DOMAIN=$(domain_from_fqdn $1);
SWARMFILE=$1

# Digital Ocean API functions
if [ -e /root/platform/swarm/lib/doctl.sh ]; then source /root/platform/swarm/lib/doctl.sh;
else source <(curl -fsSL https://github.com/nonfiction/platform/raw/master/swarm/lib/doctl.sh); fi

# Symlink swarm command if locally installed
[ -e /root/platform/swarm/swarm ] && ln -sf /root/platform/swarm/swarm /usr/local/bin/swarm >/dev/null 2>&1


# Print droplet price chart
if [ "$1" = "\$" ]; then
  echo_droplet_prices
  exit 0
fi





if undefined $SWARM; then
  echo_stop "Missing swarm name!"
  echo "The first argument for this script should be the swarm's primary's FQDN. Example: swarm app.example.com"
  exit 1
fi

if undefined $DOMAIN; then
  echo_stop "Missing domain name!"
  echo "The first argument for this script should contain swarm's domain name. Example: swarm app.example.com"
  exit 1
fi

# if has $SWARMFILE; then
#   source $SWARMFILE
# else
#   echo "Missing $SWARMFILE"
#   generate_swarmfile 
# fi

# Primary usually matches swarm name (but it doesn't have to)
PRIMARY=$(get_swarm_primary)
# Second paramter is changes to replicas (additions, removals, promotion)
CHANGES=${@:2}


# Swap a replica and primary node
PROMOTED=$(get_swarm_promotion $CHANGES)
if defined $PROMOTED; then
  DEMOTED=$PRIMARY

  # Reassign PRIMARY for display
  PRIMARY=$PROMOTED

  # Add old primary to replicas, remove new primary from replicas
  REPLICAS=$(get_swarm_replicas $DEMOTED $PROMOTED)


# Add or remove replicas
else
  REMOVALS=$(get_swarm_removals $CHANGES)
  ADDITIONS=$(get_swarm_additions $CHANGES)

  # Look up number of existing replicas in swarm, including additions, without removals
  REPLICAS=$(get_swarm_replicas "$ADDITIONS" "$REMOVALS")

  # If primary doesn't exist yet, count that as an addition
  if ! has_droplet $PRIMARY; then
    ADDITIONS="$(echo "$PRIMARY $ADDITIONS" | args)"
  else

    # Ensure new droplets have a volume size no smaller than primary's volume 
    # This is because a replicated volume will only be as largest as it's smallest node
    volume_size=$(get_volume_size $PRIMARY)
    [ "$VOLUME_SIZE" -lt "$volume_size" ] && VOLUME_SIZE=$volume_size

  fi

fi

# Combined with $PRIMARY is all nodes
NODES="$(echo "${PRIMARY} ${REPLICAS}" | xargs)"


# Display the main header
echo_line blue
echo " $(echo_color black/on_blue "[${SWARM}]") $(echo_color blue "SWARM MANAGER")"
echo_line blue

# Count the number of nodes in this swarm
count=$((1 + $(echo $REPLICAS | wc -w)))
[ "$count" = "1" ] && count="Single"
echo_next "${count}-node swarm..."
echo_line green
echo_env PRIMARY
echo_env REPLICAS
# echo_env NODES

# Display the changes to the swarm
if defined $PROMOTED || defined $REMOVALS || defined $ADDITIONS; then
  echo_next "Swarm Changes..."
  echo_line green
  if defined $PROMOTED; then
    echo_env PROMOTED
    echo_env DEMOTED
  elif defined $REMOVALS || defined $ADDITIONS; then
    echo_env REMOVALS
    echo_env ADDITIONS
  fi
fi

# Display the env variables
echo_next "Swarm Config..."
echo_line green
echo_env DOMAIN
echo_env DROPLET_IMAGE
echo_env DROPLET_SIZE
echo_env VOLUME_SIZE
echo_env FS_TYPE
echo_env REGION
echo_env ROOT_PASSWORD
echo_env ROOT_PRIVATE_KEY 20
echo_env ROOT_PUBLIC_KEY 20
echo_env WEBHOOK 24

if ask "Continue?"; then  
  echo
else
  echo_stop "Cancelled."  
  exit 1;
fi



# Promotion/demotion
defined $DEMOTED && echo_main "New Primary: ${DEMOTED} => ${PROMOTED}"
if defined $DEMOTED; then

  if droplets_ready "$NODES"; then
    echo_next "...ready!"
  else
    echo_stop "Not ready for reassignment!"
    exit
  fi

  # On primary, promote docker swarm manager to worker
  echo_run $DEMOTED "PROMOTE=1 NODE=${PROMOTED} /root/platform/swarm/node/docker"
  echo_info "Demoted $DEMOTED to worker in swarm"

  # On demoted, demote docker swarm manager to worker
  echo_run $PROMOTED "DEMOTE=1 NODE=${DEMOTED} /root/platform/swarm/node/docker"
  echo_info "Promoted $PROMOTED to manager in swarm"

  # Role tags for this swarm
  primary_tag=$(primary_tag)
  replica_tag=$(replica_tag)

  # Change the demoted node from primary to replica
  droplet_untag $DEMOTED $primary_tag
  droplet_tag $DEMOTED $replica_tag
  echo_info "Tagged $DEMOTED as ${replica_tag}"

  # Change the promoted node from replica to primary
  droplet_untag $PROMOTED $replica_tag
  droplet_tag $PROMOTED $primary_tag
  echo_info "Tagged $PROMOTED as ${primary_tag}"

  # Done
  echo
  echo_line green
  echo_color black/on_green " COMPLETE! "
  echo_line green

  exit

fi


# Deletions
defined $REMOVALS && echo_main "Node removals: ${REMOVALS}"
for node in $REMOVALS; do
  if ask "Really DELETE droplet [${node}]?"; then

    echo_next "Removing ${node} from docker swarm..."

    # On primary, demote docker swarm manager to worker
    echo_run $PRIMARY "DEMOTE=1 NODE=${node} /root/platform/swarm/node/docker"

    # On replica, leave docker swarm
    echo_run $node    "LEAVE=1 /root/platform/swarm/node/docker"

    # On primary, remove docker swarm node
    echo_run $PRIMARY "REMOVE=1 NODE=${node} /root/platform/swarm/node/docker"

    echo_next "Removing ${node} from gluster volume..."

    # On primary, remove brick and peer from gluster volume
    echo_run $PRIMARY "REMOVE=1 NODE=${node} /root/platform/swarm/node/gluster"

    # Delete DNS records 
    remove_record "${node}"
    remove_record "*.${node}"

    # Delete volume
    remove_volume "${node}"

    # Delete droplet
    remove_droplet "${node}"

  fi
done



# First node processed has a primary role
role="primary"
reset_changes

for node_name in $NODES; do
  
  echo_node_header  $node_name $role
  echo_droplet_info $node_name
  echo_volume_info  $node_name
  echo_record_info  $node_name

  if has_changes; then 
    if ask "Process droplet?"; then
      
      # First create/resize the volume that will be attached
      create_or_resize_volume $node_name $role
      
      # Then create/resize the droplet itself
      create_or_resize_droplet $node_name $role
      
      # Last, ensure the DNS records are pointing to this droplet
      public_ip="$(get_droplet_public_ip $node_name)"
      create_or_update_record "${node_name}" $public_ip
      create_or_update_record "*.${node_name}" $public_ip
      
    fi
  fi  
  reset_changes
  
  role="replica"
done


if ask "Run docker & gluster configuration on each node?"; then  
  echo
else
  echo_stop "Cancelled."  
  exit 1;
fi


# ---------------------------------------------------------
# Verify all nodes are ready
# ---------------------------------------------------------
if droplets_ready "$NODES"; then
  echo_next "...ready!"
else
  echo_stop "Not ready for configuration! Newly created droplets require 5-10 minutes."
  exit
fi

# Count the nodes
sum=$(echo $NODES | wc -w)

# ---------------------------------------------------------
# System configuration for each node
# ---------------------------------------------------------
echo_main "1. Node Config..."
count=1

# Build hosts file
hosts="127.0.0.1 localhost"
for node in $NODES; do
  ip="$(get_droplet_private_ip $node)"
  hosts="${hosts}\n${ip} ${node}"
done

# Loop all nodes in swarm
for node in $NODES; do
  
  # Current node heading
  echo_node_counter $count $sum $node
  ((count++))

  # Pull updates from git
  run $node "/root/platform/swarm/node/update"

  # Prepare environment variables for run command
  env=""
  env="${env} NODE=\"$node\""
  env="${env} DOMAIN=\"$DOMAIN\""
  env="${env} FS_TYPE=\"$FS_TYPE\""
  env="${env} HOSTS_FILE=\"$hosts\""
  env="${env} ROOT_PASSWORD=\"$ROOT_PASSWORD\""
  env="${env} ROOT_PUBLIC_KEY=\"$ROOT_PUBLIC_KEY\""

  # Run script on node
  run $node "${env} /root/platform/swarm/node/config"

done  
  

# ---------------------------------------------------------
# Create Docker Swarm and join workers
# ---------------------------------------------------------
echo_main "2. Docker Config..."
count=1

# Loop all nodes in swarm
for node in $NODES; do

  # Current node heading
  echo_node_counter $count $sum $node
  ((count++))

  # Set join token to "primary" if not replica
  if [ "$node" = "$PRIMARY" ]; then
    join_token="primary"

  # Else, get join token from primary node
  else
    join_token="$(run $PRIMARY "cat /etc/docker-join-token")"
  fi
  
  # Prepare environment variables for run command
  env="JOIN=1"
  env="${env} NODE=\"$node\""
  env="${env} PRIVATE_IP=\"$(get_droplet_private_ip $node)\""
  env="${env} JOIN_TOKEN=\"$join_token\""

  # Run script on node
  run $node "${env} /root/platform/swarm/node/docker"

done


# ---------------------------------------------------------
# Create Gluster Volume
# ---------------------------------------------------------
echo_main "3. Gluster Config..."
count=1

# Loop all nodes in swarm
for node in $NODES; do

  # Current node heading
  echo_node_counter $count $sum $node
  ((count++))

  # Prepare environment variables for run command
  env="JOIN=1"
  env="${env} NODE=\"$node\""
  env="${env} NODES=\"$NODES\""
  env="${env} PRIMARY=\"$PRIMARY\""

  # Run script on node
  run $node "${env} /root/platform/swarm/node/gluster"

done


# ---------------------------------------------------------
# Deploy Swarm
# ---------------------------------------------------------
echo_main "4. Deploy Swarm..."
run $PRIMARY "cd /root/platform && ls -lah"


# ---------------------------------------------------------
# Finish
# ---------------------------------------------------------
echo
echo_line green
echo_color black/on_green " COMPLETE! "
echo_line green

exit
